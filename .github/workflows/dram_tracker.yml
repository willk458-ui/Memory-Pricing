name: Live DRAM & NAND Market Tracker
on:
  schedule:
    - cron: '0 13 * * 1' # Runs every Monday at 1:00 PM UTC
  workflow_dispatch:      # Allows you to manually trigger it for testing

jobs:
  run-intel-report:
    runs-on: ubuntu-latest
    permissions:
      contents: write  
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install -U google-genai

      - name: Fetch Live Data and Email Report
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          RECIPIENT_EMAIL: "william.kerwin@morningstar.com"
        run: |
          python - <<EOF
          import os
          import csv
          import json
          import re
          from google import genai
          from google.genai import types
          import smtplib
          from email.message import EmailMessage
          from datetime import datetime

          api_key_from_env = os.environ.get("GEMINI_API_KEY")

          if not api_key_from_env:
              print("CRITICAL ERROR: GEMINI_API_KEY environment variable is empty or missing.")
              exit(1)

          # 1. Setup Gemini with Search Grounding
          client = genai.Client(api_key=api_key_from_env)
          
          # Dynamic search-based prompt
          today_str = datetime.now().strftime("%B %d, %Y")
          prompt = f"""
          Today's Date is {today_str}. You are a senior semiconductor analyst. 
          Use Google Search to find the LATEST pricing data from DRAMeXchange (TrendForce). Please also include percentage changes in pricing, noting either week-on-week or quarter-on-quarter changes.
          
          Requirements:
          1. DRAM & NAND Spot Prices (Session Avg): 
             - DDR5 16Gb (4800/5600), DDR4 16Gb (3200), DDR4 8Gb (3200), 512Gb TLC.
          2. Contract Price Forecast: 
             - DDR5/DDR4 (Conventional DRAM), Server DRAM, NAND Flash (Blended), Enterprise SSD.
          3. Market Dynamics: 
             - Provide 3 insights on HBM capacity impact, supplier inventory, and overall supply and demand.
          4. Format the report as a professional, bulleted email. Use bolding for prices and percentage changes.
          If specific today-only data isn't available, use the most recent session data from this week.
          5. MANDATORY: You must include a raw data block at the end. Use this exact syntax:
             DATA_START
             {{"date": "{today_str}", "ddr5_16gb": 0.00, "ddr4_16gb": 0.00, "ddr4_8gb": 0.00, "mlc_64gb": 0.00}}
             DATA_END
          """

          try:
              # Call Gemini 2.5 with the search tool enabled
              response = client.models.generate_content(
                  model="gemini-2.5-flash",
                  contents=prompt,
                  config=types.GenerateContentConfig(
                      tools=[types.Tool(google_search=types.GoogleSearch())]
                  )
              )
              
              full_text = response.text

              # Robust Extraction Logic
              report_body = full_text
              data_row = None

              # Try to find data between markers
              match = re.search(r'DATA_START\s*(.*?)\s*DATA_END', full_text, re.DOTALL)
              if match:
                  try:
                      json_str = match.group(1).strip()
                      data_row = json.loads(json_str)
                      report_body = full_text.split("DATA_START")[0].strip()
                  except Exception as e:
                      print(f"JSON Parse Error: {e}")

              # Save to CSV
              if data_row:
                csv_file = 'dram_prices.csv'
                file_exists = os.path.isfile(csv_file)
                with open(csv_file, 'a', newline='') as f:
                  writer = csv.DictWriter(f, fieldnames=data_row.keys())
                  if not file_exists:
                      writer.writeheader()
                  writer.writerow(data_row)
                print("CSV Updated.")

              # Create Email Message
              msg = EmailMessage()
              msg.set_content(report_body)
              msg['Subject'] = f'DRAMeXchange Intelligence Report: {today_str}'
              msg['From'] = os.environ["EMAIL_USER"]
              msg['To'] = os.environ["RECIPIENT_EMAIL"]

              # Send via SMTP
              with smtplib.SMTP_SSL('smtp.gmail.com', 465) as smtp:
                  smtp.login(os.environ["EMAIL_USER"], os.environ["EMAIL_PASS"])
                  smtp.send_message(msg)
              
              print(f"SUCCESS: Report for {today_str} sent to {os.environ['RECIPIENT_EMAIL']}")

          except Exception as e:
              print(f"CRITICAL ERROR: {e}")
              exit(1)
          EOF
          
      - name: Commit and Push CSV changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add dram_prices.csv
          git commit -m "Update historical DRAM prices for $(date +'%Y-%m-%d')" || echo "No changes to commit"
          git push
